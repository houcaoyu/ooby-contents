angular.module('common.content', ['core.content','core.user','core.comment','core.loginout','ui.router']).
  controller('contentCtrl',function(Content,Comment,User,$scope,$stateParams,LoginOut){
      Content.get({id:$stateParams.contentId},function(content){
        $scope.content=content
        $scope.isOwn=LoginOut.user?$scope.content.contentGroup.user.id==LoginOut.user.id:false
      })
      $scope.toggleLike=function(){
        if(!$scope.content.liked)
          Content.like({id:$scope.content.id},function(){
            $scope.content.liked=true
          })
        else
          Content.unlike({id:$scope.content.id},function(){
            $scope.content.liked=false
          })
      }
      $scope.toggleCollect=function(){
        if(!$scope.content.collected)
          Content.collect({id:$scope.content.id},function(){
            $scope.content.collected=true
          })
        else
          Content.uncollect({id:$scope.content.id},function(){
            $scope.content.collected=false
          })
      }
      $scope.toggleFollow=function(){
        if(!$scope.content.contentGroup.user.followed)
          User.follow({id:$scope.content.contentGroup.user.id},function(){
            $scope.content.contentGroup.user.followed=true
          })
        else
          User.unfollow({id:$scope.content.contentGroup.user.id},function(){
            $scope.content.contentGroup.user.followed=false
          })
      }
      $scope.commentDialogShow=false
      $scope.showCommentDialog=function(event){
        $scope.commentDialogShow=true;
        event.stopPropagation();
        angular.element(document).one('click',function(){
          $scope.commentDialogShow=false;
          $scope.$digest();
        })
      }

      $scope.submitComment=function(){
        if($scope.form.$invalid)
          return

        Comment.save({text:$scope.text,contentId:$scope.content.id},
            function(comment){
              $scope.text=''
              alert('提交成功')
              $scope.content.comments.push(comment)
              $scope.commentDialogShow=false;
            },
            function(response){

            })
      }

  })
